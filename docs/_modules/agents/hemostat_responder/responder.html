

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>agents.hemostat_responder.responder &mdash; HemoStat Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            HemoStat
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">System Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_protocol.html">API Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deployment.html">Deployment Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting.html">Troubleshooting Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development.html">Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html#base-classes">Base Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html#indices-and-tables">Indices and tables</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">HemoStat</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">agents.hemostat_responder.responder</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for agents.hemostat_responder.responder</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">HemoStat Responder Agent - Safe Container Remediation</span>

<span class="sd">Executes remediation actions recommended by the Analyzer Agent with comprehensive</span>
<span class="sd">safety constraints including cooldown periods, circuit breakers, and audit logging.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">UTC</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">docker</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">docker.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIError</span><span class="p">,</span> <span class="n">DockerException</span><span class="p">,</span> <span class="n">NotFound</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">agents.agent_base</span><span class="w"> </span><span class="kn">import</span> <span class="n">HemoStatAgent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agents.platform_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_docker_host</span>


<div class="viewcode-block" id="ContainerResponder">
<a class="viewcode-back" href="../../../api/agents.html#agents.hemostat_responder.responder.ContainerResponder">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ContainerResponder</span><span class="p">(</span><span class="n">HemoStatAgent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes safe container remediation with multi-layered safety mechanisms.</span>

<span class="sd">    Subscribes to hemostat:remediation_needed channel and executes Docker operations</span>
<span class="sd">    (restart, scale, cleanup, exec) while enforcing cooldown periods, circuit breakers,</span>
<span class="sd">    and maintaining comprehensive audit logs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ContainerResponder.__init__">
<a class="viewcode-back" href="../../../api/agents.html#agents.hemostat_responder.responder.ContainerResponder.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Responder Agent.</span>

<span class="sd">        Connects to Docker daemon with retry logic, loads safety configuration from</span>
<span class="sd">        environment variables, and subscribes to remediation_needed channel.</span>

<span class="sd">        Raises:</span>
<span class="sd">            HemoStatConnectionError: If Redis connection fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">agent_name</span><span class="o">=</span><span class="s2">&quot;responder&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize Docker client with exponential backoff retry logic</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">docker_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect_docker</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">docker_available</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">DockerException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Docker client unavailable (running in Docker without socket mount): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Responder will continue via Redis events only.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">docker_client</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">docker_available</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Load safety configuration from environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooldown_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RESPONDER_COOLDOWN_SECONDS&quot;</span><span class="p">,</span> <span class="s2">&quot;3600&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries_per_hour</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RESPONDER_MAX_RETRIES_PER_HOUR&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RESPONDER_DRY_RUN&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enforce_exec_allowlist</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RESPONDER_ENFORCE_EXEC_ALLOWLIST&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Subscribe to remediation channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subscribe_to_channel</span><span class="p">(</span><span class="s2">&quot;hemostat:remediation_needed&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_remediation_request</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Responder Agent initialized - &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;cooldown=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cooldown_seconds</span><span class="si">}</span><span class="s2">s, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;max_retries=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries_per_hour</span><span class="si">}</span><span class="s2">/hour, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;dry_run=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;enforce_exec_allowlist=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">enforce_exec_allowlist</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_connect_docker</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">docker</span><span class="o">.</span><span class="n">DockerClient</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect to Docker daemon with exponential backoff retry logic.</span>

<span class="sd">        Uses platform-aware Docker socket detection. Automatically selects the</span>
<span class="sd">        appropriate socket path for Windows (npipe), Linux, or macOS (unix socket).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Connected Docker client instance</span>

<span class="sd">        Raises:</span>
<span class="sd">            DockerException: If connection fails after configured attempts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_retries</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RESPONDER_RETRY_MAX&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">))</span>
        <span class="n">initial_delay</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RESPONDER_RETRY_DELAY&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>
        <span class="n">docker_host</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DOCKER_HOST&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">get_docker_host</span><span class="p">()</span>

        <span class="n">retry_delays</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_delay</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">)]</span>
        <span class="n">last_error</span><span class="p">:</span> <span class="n">DockerException</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">client</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="n">from_env</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Docker client initialized: </span><span class="si">{</span><span class="n">docker_host</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">client</span>
            <span class="k">except</span> <span class="n">DockerException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">last_error</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">wait_time</span> <span class="o">=</span> <span class="n">retry_delays</span><span class="p">[</span><span class="n">attempt</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to connect to Docker (attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">). &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Retrying in </span><span class="si">{</span><span class="n">wait_time</span><span class="si">}</span><span class="s2">s... Error: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_time</span><span class="p">)</span>

        <span class="c1"># All retries exhausted - raise the error</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to connect to Docker after </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> attempts. Last error: </span><span class="si">{</span><span class="n">last_error</span><span class="si">!s}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="n">DockerException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">last_error</span>

<div class="viewcode-block" id="ContainerResponder.run">
<a class="viewcode-back" href="../../../api/agents.html#agents.hemostat_responder.responder.ContainerResponder.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the message listening loop.</span>

<span class="sd">        Blocks until stop() is called. Listens for remediation requests on</span>
<span class="sd">        hemostat:remediation_needed channel and processes them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Responder Agent listening loop&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_listening</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in listening loop: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_remediation_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback invoked when remediation request is received from Analyzer Agent.</span>

<span class="sd">        Args:</span>
<span class="sd">            message: Full message wrapper with event_type, timestamp, agent, data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Extract request payload from message wrapper</span>
            <span class="n">request_data</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received remediation request: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">request_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_remediation</span><span class="p">(</span><span class="n">request_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error handling remediation request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_execute_remediation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main remediation orchestration method.</span>

<span class="sd">        Performs safety checks (cooldown, circuit breaker) and routes to appropriate</span>
<span class="sd">        action handler. Updates state and publishes completion event.</span>

<span class="sd">        Args:</span>
<span class="sd">            request_data: Remediation request with container, action, and metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">container</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;container&quot;</span><span class="p">)</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">container</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">action</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid remediation request: missing container or action&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Safety Check 1: Cooldown period</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_cooldown</span><span class="p">(</span><span class="n">container</span><span class="p">):</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cooldown_remaining</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cooldown active for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">remaining</span><span class="si">}</span><span class="s2">s remaining&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_publish_cooldown_active</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">remaining</span><span class="p">,</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_audit_trail</span><span class="p">(</span>
                <span class="n">container</span><span class="p">,</span>
                <span class="n">action</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;rejected&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;cooldown_active&quot;</span><span class="p">},</span>
                <span class="n">request_data</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Safety Check 2: Circuit breaker</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_circuit_breaker</span><span class="p">(</span><span class="n">container</span><span class="p">):</span>
            <span class="n">cb_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shared_state</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;circuit_breaker:</span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">retry_count</span> <span class="o">=</span> <span class="n">cb_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;retry_count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker open for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">retry_count</span><span class="si">}</span><span class="s2"> retries&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_publish_circuit_breaker_active</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">,</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_audit_trail</span><span class="p">(</span>
                <span class="n">container</span><span class="p">,</span>
                <span class="n">action</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;rejected&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;circuit_breaker_open&quot;</span><span class="p">},</span>
                <span class="n">request_data</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Safety Check 3: Dry-run mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run_action</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">request_data</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Route to appropriate action handler</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;restart&quot;</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restart_container</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;scale_up&quot;</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_container</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;cleanup&quot;</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_container</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;exec&quot;</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exec_container</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Unknown action: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown remediation action: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error executing </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Update state based on result (treat not_applicable as non-failure)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;not_applicable&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;not_applicable&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_remediation_history</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_circuit_breaker</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">success</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Log not_applicable but don&#39;t trigger cooldown or circuit breaker</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Action </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2"> not applicable for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Publish completion event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_publish_remediation_complete</span><span class="p">(</span><span class="n">request_data</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

        <span class="c1"># Log audit trail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_audit_trail</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">request_data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_cooldown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if cooldown period has elapsed since last remediation action.</span>

<span class="sd">        Args:</span>
<span class="sd">            container: Container name</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if cooldown expired or no previous action, False if within cooldown</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shared_state</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;remediation_history:</span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">history</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No remediation history for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">last_timestamp</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_action_timestamp&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">last_timestamp</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">last_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span> <span class="o">-</span> <span class="n">last_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooldown_seconds</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cooldown active for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">}</span><span class="s2">s elapsed, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cooldown_seconds</span><span class="si">}</span><span class="s2">s required&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cooldown expired for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">}</span><span class="s2">s elapsed&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking cooldown for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_cooldown_remaining</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get remaining cooldown time in seconds.</span>

<span class="sd">        Calculates how many seconds remain in the cooldown period for a container.</span>

<span class="sd">        Args:</span>
<span class="sd">            container: Container name</span>

<span class="sd">        Returns:</span>
<span class="sd">            Remaining cooldown time in seconds (0 if no cooldown active)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shared_state</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;remediation_history:</span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">last_timestamp</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_action_timestamp&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">last_timestamp</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">last_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">last_timestamp</span><span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span> <span class="o">-</span> <span class="n">last_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cooldown_seconds</span> <span class="o">-</span> <span class="n">elapsed</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">remaining</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_circuit_breaker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if circuit breaker is open (max retries exceeded).</span>

<span class="sd">        Args:</span>
<span class="sd">            container: Container name</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if circuit closed (safe to proceed), False if circuit open</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cb_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shared_state</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;circuit_breaker:</span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cb_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No circuit breaker state for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Check if hour window has elapsed (reset circuit)</span>
        <span class="n">opened_timestamp</span> <span class="o">=</span> <span class="n">cb_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;opened_timestamp&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opened_timestamp</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">opened_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">opened_timestamp</span><span class="p">)</span>
                <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span> <span class="o">-</span> <span class="n">opened_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="mi">3600</span><span class="p">:</span>  <span class="c1"># 1 hour</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker hour window elapsed for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking circuit breaker window: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check if circuit is open</span>
        <span class="n">is_open</span> <span class="o">=</span> <span class="n">cb_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_open&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_open</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Circuit breaker open for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cb_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;retry_count&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> retries&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker closed for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_restart_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restart a container gracefully.</span>

<span class="sd">        Args:</span>
<span class="sd">            container: Container name or ID</span>

<span class="sd">        Returns:</span>
<span class="sd">            Result dict with status and details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restarting container: </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">container_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_client</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
            <span class="n">container_obj</span><span class="o">.</span><span class="n">restart</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

            <span class="c1"># Wait for container to reach running state</span>
            <span class="n">max_wait</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="n">max_wait</span><span class="p">:</span>
                <span class="n">container_obj</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">container_obj</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Container restarted successfully: </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">{</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;restart&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;container&quot;</span><span class="p">:</span> <span class="n">container</span><span class="p">,</span>
                        <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;Container restarted and running&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Timeout waiting for running state</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Container did not reach running state within </span><span class="si">{</span><span class="n">max_wait</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="n">NotFound</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Container not found: </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>
        <span class="k">except</span> <span class="n">APIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Docker API error restarting </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_scale_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scale container replicas (Docker Swarm services).</span>

<span class="sd">        Args:</span>
<span class="sd">            container: Container or service name</span>

<span class="sd">        Returns:</span>
<span class="sd">            Result dict with status and details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scaling container: </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Get container to check for Swarm service labels</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">container_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_client</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">container_obj</span><span class="o">.</span><span class="n">labels</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="n">NotFound</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Container not found: </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>

            <span class="c1"># Check if container is part of a Swarm service</span>
            <span class="n">service_name</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;com.docker.swarm.service.name&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">service_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Scale operation not applicable for standalone containers. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Container </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2"> is not part of a Docker Swarm service.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;not_applicable&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;scale_up&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;container&quot;</span><span class="p">:</span> <span class="n">container</span><span class="p">,</span>
                    <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;Scale operation not applicable - requires Docker Swarm service&quot;</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="c1"># Find and scale the Swarm service</span>
            <span class="n">services</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_client</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">service_name</span><span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">services</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Swarm service not found: </span><span class="si">{</span><span class="n">service_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;not_applicable&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;scale_up&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;container&quot;</span><span class="p">:</span> <span class="n">container</span><span class="p">,</span>
                    <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Swarm service </span><span class="si">{</span><span class="n">service_name</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="n">service</span> <span class="o">=</span> <span class="n">services</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">current_spec</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Spec&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">current_mode</span> <span class="o">=</span> <span class="n">current_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Mode&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">current_replicas</span> <span class="o">=</span> <span class="n">current_mode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Replicated&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Replicas&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">new_replicas</span> <span class="o">=</span> <span class="n">current_replicas</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># Update service replicas</span>
            <span class="n">current_mode</span><span class="p">[</span><span class="s2">&quot;Replicated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Replicas&quot;</span><span class="p">:</span> <span class="n">new_replicas</span><span class="p">}</span>
            <span class="n">current_spec</span><span class="p">[</span><span class="s2">&quot;Mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_mode</span>
            <span class="n">service</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">current_mode</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Scaled service </span><span class="si">{</span><span class="n">service_name</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">current_replicas</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_replicas</span><span class="si">}</span><span class="s2"> replicas&quot;</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;scale_up&quot;</span><span class="p">,</span>
                <span class="s2">&quot;container&quot;</span><span class="p">:</span> <span class="n">container</span><span class="p">,</span>
                <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;service&quot;</span><span class="p">:</span> <span class="n">service_name</span><span class="p">,</span>
                    <span class="s2">&quot;previous_replicas&quot;</span><span class="p">:</span> <span class="n">current_replicas</span><span class="p">,</span>
                    <span class="s2">&quot;new_replicas&quot;</span><span class="p">:</span> <span class="n">new_replicas</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="n">APIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Docker API error scaling </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean up stopped containers and prune unused resources strictly scoped to target container.</span>

<span class="sd">        Args:</span>
<span class="sd">            container: Container name or ID (used for filtering)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Result dict with cleanup statistics</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleaning up resources for container: </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Get target container info for scoped cleanup</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">target_container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_client</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
                <span class="n">image_id</span> <span class="o">=</span> <span class="n">target_container</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">id</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">target_container</span><span class="o">.</span><span class="n">labels</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="n">NotFound</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Container not found: </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>

            <span class="n">cleanup_stats</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;containers_removed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;volumes_removed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;space_reclaimed_bytes&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="p">}</span>

            <span class="c1"># Build container filters combining constraints</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;exited&quot;</span><span class="p">]}</span>
            <span class="n">compose_project</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;com.docker.compose.project&quot;</span><span class="p">)</span>
            <span class="n">compose_service</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;com.docker.compose.service&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">compose_project</span><span class="p">:</span>
                <span class="c1"># Build label filters for Compose project and optionally service</span>
                <span class="n">label_filters</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;com.docker.compose.project=</span><span class="si">{</span><span class="n">compose_project</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">compose_service</span><span class="p">:</span>
                    <span class="n">label_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;com.docker.compose.service=</span><span class="si">{</span><span class="n">compose_service</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_filters</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Using Compose filters: project=</span><span class="si">{</span><span class="n">compose_project</span><span class="si">}</span><span class="s2">, service=</span><span class="si">{</span><span class="n">compose_service</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Filter by ancestor image to match containers from same image</span>
                <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;ancestor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_id</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using image filter: ancestor=</span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># List and remove scoped stopped containers</span>
            <span class="n">stopped_containers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_client</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
            <span class="n">removed_container_ids</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">stopped_container</span> <span class="ow">in</span> <span class="n">stopped_containers</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Double-check status before removal</span>
                    <span class="n">stopped_container</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">stopped_container</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping running container: </span><span class="si">{</span><span class="n">stopped_container</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing stopped container: </span><span class="si">{</span><span class="n">stopped_container</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">stopped_container</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Remove with volumes</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cleanup_stats</span><span class="p">[</span><span class="s2">&quot;containers_removed&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                        <span class="n">cleanup_stats</span><span class="p">[</span><span class="s2">&quot;containers_removed&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">removed_container_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stopped_container</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">APIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to remove container </span><span class="si">{</span><span class="n">stopped_container</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Prune volumes strictly scoped</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">volumes_removed_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">space_reclaimed</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">compose_project</span><span class="p">:</span>
                    <span class="c1"># Prune volumes with Compose project label filter</span>
                    <span class="n">volume_filters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;com.docker.compose.project=</span><span class="si">{</span><span class="n">compose_project</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]}</span>
                    <span class="k">if</span> <span class="n">compose_service</span><span class="p">:</span>
                        <span class="n">volume_filters</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;com.docker.compose.service=</span><span class="si">{</span><span class="n">compose_service</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pruning volumes with filters: </span><span class="si">{</span><span class="n">volume_filters</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">volumes_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_client</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">prune</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">volume_filters</span><span class="p">)</span>
                    <span class="n">volumes_removed_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumes_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;VolumesDeleted&quot;</span><span class="p">,</span> <span class="p">[]))</span>
                    <span class="n">space_reclaimed</span> <span class="o">=</span> <span class="n">volumes_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SpaceReclaimed&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pruned </span><span class="si">{</span><span class="n">volumes_removed_count</span><span class="si">}</span><span class="s2"> Compose-scoped volumes&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># No Compose labels: enumerate dangling volumes and match to removed containers</span>
                    <span class="k">if</span> <span class="n">removed_container_ids</span><span class="p">:</span>
                        <span class="n">dangling_volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_client</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                            <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dangling&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">vol</span> <span class="ow">in</span> <span class="n">dangling_volumes</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># Check if volume is referenced by removed containers or has matching labels</span>
                                <span class="n">vol_labels</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Labels&quot;</span><span class="p">,</span> <span class="p">{})</span>
                                <span class="k">if</span> <span class="n">vol_labels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;com.docker.compose.project&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
                                    <span class="n">cid</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">vol</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span> <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">removed_container_ids</span>
                                <span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing dangling volume: </span><span class="si">{</span><span class="n">vol</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="n">vol</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                                    <span class="n">volumes_removed_count</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">except</span> <span class="n">APIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to remove volume </span><span class="si">{</span><span class="n">vol</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cleanup_stats</span><span class="p">[</span><span class="s2">&quot;notes&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">cleanup_stats</span><span class="p">[</span><span class="s2">&quot;notes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="s2">&quot;No containers removed; skipping volume pruning&quot;</span>
                            <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No containers removed; skipping volume pruning&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cleanup_stats</span><span class="p">[</span><span class="s2">&quot;volumes_removed&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">cleanup_stats</span><span class="p">[</span><span class="s2">&quot;volumes_removed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volumes_removed_count</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cleanup_stats</span><span class="p">[</span><span class="s2">&quot;space_reclaimed_bytes&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">cleanup_stats</span><span class="p">[</span><span class="s2">&quot;space_reclaimed_bytes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">space_reclaimed</span>
            <span class="k">except</span> <span class="n">APIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to prune volumes: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cleanup_stats</span><span class="p">[</span><span class="s2">&quot;notes&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">cleanup_stats</span><span class="p">[</span><span class="s2">&quot;notes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Volume pruning failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cleanup complete: </span><span class="si">{</span><span class="n">cleanup_stats</span><span class="p">[</span><span class="s1">&#39;containers_removed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> containers removed, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cleanup_stats</span><span class="p">[</span><span class="s1">&#39;volumes_removed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> volumes removed, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cleanup_stats</span><span class="p">[</span><span class="s1">&#39;space_reclaimed_bytes&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> bytes reclaimed&quot;</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;cleanup&quot;</span><span class="p">,</span>
                <span class="s2">&quot;container&quot;</span><span class="p">:</span> <span class="n">container</span><span class="p">,</span>
                <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">cleanup_stats</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="n">APIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Docker API error during cleanup: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_exec_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute diagnostic command inside container.</span>

<span class="sd">        Args:</span>
<span class="sd">            container: Container name or ID</span>
<span class="sd">            command: Command to execute (default: ps aux)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Result dict with command output and exit code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">command</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;ps aux&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing command in </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Security: Validate command against whitelist of safe diagnostic commands</span>
            <span class="n">safe_commands</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;ps aux&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ps&quot;</span><span class="p">,</span>
                <span class="s2">&quot;top&quot;</span><span class="p">,</span>
                <span class="s2">&quot;df&quot;</span><span class="p">,</span>
                <span class="s2">&quot;free&quot;</span><span class="p">,</span>
                <span class="s2">&quot;netstat&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ss&quot;</span><span class="p">,</span>
                <span class="s2">&quot;env&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pwd&quot;</span><span class="p">,</span>
                <span class="s2">&quot;whoami&quot;</span><span class="p">,</span>
                <span class="s2">&quot;date&quot;</span><span class="p">,</span>
                <span class="s2">&quot;uptime&quot;</span><span class="p">,</span>
                <span class="s2">&quot;uname&quot;</span><span class="p">,</span>
            <span class="p">]</span>

            <span class="n">command_allowed</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">safe_cmd</span><span class="p">)</span> <span class="k">for</span> <span class="n">safe_cmd</span> <span class="ow">in</span> <span class="n">safe_commands</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">command_allowed</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforce_exec_allowlist</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Command not in allowlist (enforce_exec_allowlist=true): </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;rejected&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command not in whitelist, executing anyway: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">container_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_client</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>

            <span class="c1"># Check if container is running</span>
            <span class="n">container_obj</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">container_obj</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Container not running: </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2"> (status: </span><span class="si">{</span><span class="n">container_obj</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>

            <span class="c1"># Execute command</span>
            <span class="n">exit_code</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">container_obj</span><span class="o">.</span><span class="n">exec_run</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

            <span class="c1"># Decode output if bytes</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command executed in </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">: exit_code=</span><span class="si">{</span><span class="n">exit_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;exec&quot;</span><span class="p">,</span>
                <span class="s2">&quot;container&quot;</span><span class="p">:</span> <span class="n">container</span><span class="p">,</span>
                <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">command</span><span class="p">,</span>
                <span class="s2">&quot;exit_code&quot;</span><span class="p">:</span> <span class="n">exit_code</span><span class="p">,</span>
                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">output</span><span class="p">[:</span><span class="mi">1000</span><span class="p">],</span>  <span class="c1"># Limit output to 1000 chars</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="n">NotFound</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Container not found: </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>
        <span class="k">except</span> <span class="n">APIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Docker API error executing command: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_dry_run_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulate remediation action without executing.</span>

<span class="sd">        Args:</span>
<span class="sd">            container: Container name</span>
<span class="sd">            action: Remediation action</span>
<span class="sd">            request_data: Original request data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DRY RUN: Would execute </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Simulate operation time</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
            <span class="s2">&quot;container&quot;</span><span class="p">:</span> <span class="n">container</span><span class="p">,</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Dry-run simulation of </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Publish success event with dry_run flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_publish_remediation_complete</span><span class="p">(</span><span class="n">request_data</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Log audit trail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_audit_trail</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">request_data</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_remediation_history</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update remediation history in Redis.</span>

<span class="sd">        Args:</span>
<span class="sd">            container: Container name</span>
<span class="sd">            action: Remediation action</span>
<span class="sd">            result: Action result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shared_state</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;remediation_history:</span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>

            <span class="c1"># Update last action timestamp</span>
            <span class="n">history</span><span class="p">[</span><span class="s2">&quot;last_action_timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="n">history</span><span class="p">[</span><span class="s2">&quot;last_action&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">action</span>
            <span class="n">history</span><span class="p">[</span><span class="s2">&quot;last_result_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span>

            <span class="c1"># Update retry count (increment if within same hour, reset if new hour)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span>
                <span class="n">history</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">last_retry_hour</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_retry_hour&quot;</span><span class="p">)</span>
                <span class="n">current_hour</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">last_retry_hour</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">last_hour</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">last_retry_hour</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">last_hour</span> <span class="o">==</span> <span class="n">current_hour</span><span class="p">:</span>
                            <span class="n">history</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;retry_count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">history</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">history</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">history</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="n">history</span><span class="p">[</span><span class="s2">&quot;last_retry_hour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_hour</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_shared_state</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;remediation_history:</span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">history</span><span class="p">,</span>
                <span class="n">ttl</span><span class="o">=</span><span class="mi">7200</span><span class="p">,</span>  <span class="c1"># 2 hours</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated remediation history for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating remediation history: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_circuit_breaker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update circuit breaker state in Redis with rolling 1-hour window.</span>

<span class="sd">        Args:</span>
<span class="sd">            container: Container name</span>
<span class="sd">            success: Whether remediation was successful</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cb_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shared_state</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;circuit_breaker:</span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span>

            <span class="c1"># Check if 1-hour window has elapsed and reset if needed</span>
            <span class="n">opened_timestamp_str</span> <span class="o">=</span> <span class="n">cb_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;opened_timestamp&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">opened_timestamp_str</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">opened_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">opened_timestamp_str</span><span class="p">)</span>
                    <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">opened_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="mi">3600</span><span class="p">:</span>  <span class="c1"># 1 hour</span>
                        <span class="c1"># Reset circuit breaker after 1-hour window</span>
                        <span class="n">cb_state</span><span class="p">[</span><span class="s2">&quot;is_open&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">cb_state</span><span class="p">[</span><span class="s2">&quot;failure_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">cb_state</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">cb_state</span><span class="p">[</span><span class="s2">&quot;opened_timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Circuit breaker window elapsed for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">, resetting&quot;</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking circuit breaker window: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="c1"># Reset on success</span>
                <span class="n">cb_state</span><span class="p">[</span><span class="s2">&quot;is_open&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">cb_state</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">cb_state</span><span class="p">[</span><span class="s2">&quot;failure_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker closed for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Increment failure count</span>
                <span class="n">failure_count</span> <span class="o">=</span> <span class="n">cb_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;failure_count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">cb_state</span><span class="p">[</span><span class="s2">&quot;failure_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">failure_count</span>

                <span class="c1"># Check if we should open circuit</span>
                <span class="k">if</span> <span class="n">failure_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries_per_hour</span><span class="p">:</span>
                    <span class="n">cb_state</span><span class="p">[</span><span class="s2">&quot;is_open&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">cb_state</span><span class="p">[</span><span class="s2">&quot;opened_timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Circuit breaker opened for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">failure_count</span><span class="si">}</span><span class="s2"> failures&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cb_state</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">failure_count</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_shared_state</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;circuit_breaker:</span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">cb_state</span><span class="p">,</span>
                <span class="n">ttl</span><span class="o">=</span><span class="mi">7200</span><span class="p">,</span>  <span class="c1"># 2 hours</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating circuit breaker: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_publish_remediation_complete</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">request_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Publish remediation completion event.</span>

<span class="sd">        Args:</span>
<span class="sd">            request_data: Original remediation request</span>
<span class="sd">            result: Action result</span>
<span class="sd">            dry_run: Whether this was a dry-run</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Build data without event_type or timestamp</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;container&quot;</span><span class="p">:</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;container&quot;</span><span class="p">),</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">),</span>
                <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
                <span class="s2">&quot;dry_run&quot;</span><span class="p">:</span> <span class="n">dry_run</span><span class="p">,</span>
                <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">),</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">),</span>
            <span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">publish_event</span><span class="p">(</span><span class="s2">&quot;hemostat:remediation_complete&quot;</span><span class="p">,</span> <span class="s2">&quot;remediation_complete&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Published remediation_complete: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;container&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Published remediation_complete: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;container&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error publishing remediation_complete: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_audit_trail</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">request_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log comprehensive audit trail to Redis.</span>

<span class="sd">        Args:</span>
<span class="sd">            container: Container name</span>
<span class="sd">            action: Remediation action</span>
<span class="sd">            result: Action result</span>
<span class="sd">            request_data: Original request data</span>
<span class="sd">            dry_run: Whether this was a dry-run</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">audit_entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;container&quot;</span><span class="p">:</span> <span class="n">container</span><span class="p">,</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                <span class="s2">&quot;result_status&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">),</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">),</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">),</span>
                <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">),</span>
                <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metrics&quot;</span><span class="p">),</span>
                <span class="s2">&quot;dry_run&quot;</span><span class="p">:</span> <span class="n">dry_run</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Store in Redis list (LPUSH for newest first)</span>
            <span class="n">audit_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;hemostat:audit:</span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span><span class="n">audit_key</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">audit_entry</span><span class="p">))</span>

            <span class="c1"># Keep only last 100 entries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">ltrim</span><span class="p">(</span><span class="n">audit_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>

            <span class="c1"># Set TTL (7 days)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">audit_key</span><span class="p">,</span> <span class="mi">604800</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Logged audit trail for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error logging audit trail: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_publish_cooldown_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">remaining_seconds</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Publish cooldown active event.</span>

<span class="sd">        Args:</span>
<span class="sd">            container: Container name</span>
<span class="sd">            action: Original remediation action</span>
<span class="sd">            remaining_seconds: Seconds remaining in cooldown</span>
<span class="sd">            confidence: Confidence level from original request</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Structure rejection events with result object</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;container&quot;</span><span class="p">:</span> <span class="n">container</span><span class="p">,</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;rejected&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;cooldown_active&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;remaining_seconds&quot;</span><span class="p">:</span> <span class="n">remaining_seconds</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">publish_event</span><span class="p">(</span><span class="s2">&quot;hemostat:remediation_complete&quot;</span><span class="p">,</span> <span class="s2">&quot;remediation_complete&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cooldown active for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">remaining_seconds</span><span class="si">}</span><span class="s2">s remaining&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error publishing cooldown_active: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_publish_circuit_breaker_active</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Publish circuit breaker open event.</span>

<span class="sd">        Args:</span>
<span class="sd">            container: Container name</span>
<span class="sd">            action: Original remediation action</span>
<span class="sd">            retry_count: Current retry count</span>
<span class="sd">            confidence: Confidence level from original request</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Structure rejection events with result object</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;container&quot;</span><span class="p">:</span> <span class="n">container</span><span class="p">,</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;rejected&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;circuit_breaker_open&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;retry_count&quot;</span><span class="p">:</span> <span class="n">retry_count</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">publish_event</span><span class="p">(</span><span class="s2">&quot;hemostat:remediation_complete&quot;</span><span class="p">,</span> <span class="s2">&quot;remediation_complete&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker open for </span><span class="si">{</span><span class="n">container</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">retry_count</span><span class="si">}</span><span class="s2"> retries&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error publishing circuit_breaker_active: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Team 1.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>