services:
  # Redis service for pub/sub messaging and shared state
  redis:
    image: redis:7-alpine
    container_name: hemostat-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - hemostat-network

  # Monitor Agent - Continuously polls Docker containers for health issues
  monitor:
    container_name: hemostat-monitor
    user: root
    build:
      context: .
      dockerfile: agents/hemostat_monitor/Dockerfile
    environment:
      DOCKER_HOST: unix:///var/run/docker.sock
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      AGENT_POLL_INTERVAL: ${AGENT_POLL_INTERVAL:-30}
      THRESHOLD_CPU_PERCENT: ${THRESHOLD_CPU_PERCENT:-85}
      THRESHOLD_MEMORY_PERCENT: ${THRESHOLD_MEMORY_PERCENT:-80}
      MONITOR_CONTAINER_BLACKLIST: ${MONITOR_CONTAINER_BLACKLIST:-hemostat-*}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import redis; redis.Redis(host='redis').ping()",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network

  # Analyzer Agent - Performs AI-powered root cause analysis of health issues
  analyzer:
    container_name: hemostat-analyzer
    build:
      context: .
      dockerfile: agents/hemostat_analyzer/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      AI_MODEL: ${AI_MODEL:-gpt-4}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      HUGGINGFACE_API_KEY: ${HUGGINGFACE_API_KEY}
      AI_FALLBACK_ENABLED: ${AI_FALLBACK_ENABLED:-true}
      ANALYZER_CONFIDENCE_THRESHOLD: ${ANALYZER_CONFIDENCE_THRESHOLD:-0.7}
      ANALYZER_HISTORY_SIZE: ${ANALYZER_HISTORY_SIZE:-10}
      ANALYZER_HISTORY_TTL: ${ANALYZER_HISTORY_TTL:-3600}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import redis; redis.Redis(host='redis').ping()",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network

  # Responder Agent - Executes safe container remediation with safety constraints
  responder:
    container_name: hemostat-responder
    user: root
    build:
      context: .
      dockerfile: agents/hemostat_responder/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      RESPONDER_COOLDOWN_SECONDS: ${RESPONDER_COOLDOWN_SECONDS:-3600}
      RESPONDER_MAX_RETRIES_PER_HOUR: ${RESPONDER_MAX_RETRIES_PER_HOUR:-3}
      RESPONDER_DRY_RUN: ${RESPONDER_DRY_RUN:-false}
      RESPONDER_ENFORCE_EXEC_ALLOWLIST: ${RESPONDER_ENFORCE_EXEC_ALLOWLIST:-false}
      DOCKER_HOST: unix:///var/run/docker.sock
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import redis; redis.Redis(host='redis').ping()",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network

  # Alert Agent - Sends notifications and stores events for dashboard
  alert:
    container_name: hemostat-alert
    build:
      context: .
      dockerfile: agents/hemostat_alert/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL}
      ALERT_ENABLED: ${ALERT_ENABLED:-true}
      ALERT_EVENT_TTL: ${ALERT_EVENT_TTL:-3600}
      ALERT_MAX_EVENTS: ${ALERT_MAX_EVENTS:-100}
      ALERT_DEDUPE_TTL: ${ALERT_DEDUPE_TTL:-60}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import redis; redis.Redis(host='redis').ping()",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network

  # Metrics Exporter - Exposes Prometheus metrics for observability
  metrics:
    container_name: hemostat-metrics
    build:
      context: .
      dockerfile: agents/hemostat_metrics/Dockerfile
    ports:
      - "9090:9090"
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      METRICS_PORT: ${METRICS_PORT:-9090}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:9090/metrics')",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network

  # Prometheus - Time-series database for metrics collection
  prometheus:
    container_name: hemostat-prometheus
    image: prom/prometheus:latest
    ports:
      - "9091:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/rules:/etc/prometheus/rules:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    depends_on:
      - metrics
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network

  # Grafana - Metrics visualization and dashboards
  grafana:
    container_name: hemostat-grafana
    image: grafana/grafana:latest
    ports:
      - "3001:3001"
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3001
      - GF_INSTALL_PLUGINS=
    depends_on:
      - prometheus
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network

  # Vulnerability Scanner Agent - OWASP ZAP integration for security scanning
  vulnscanner:
    container_name: hemostat-vulnscanner
    build:
      context: .
      dockerfile: agents/hemostat_vulnscanner/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      ZAP_HOST: zap
      ZAP_PORT: 8080
      VULNSCANNER_INTERVAL: ${VULNSCANNER_INTERVAL:-3600}
      VULNSCANNER_TIMEOUT: ${VULNSCANNER_TIMEOUT:-1800}
      VULNSCANNER_MAX_TIME: ${VULNSCANNER_MAX_TIME:-3600}
      VULNSCANNER_TARGETS: ${VULNSCANNER_TARGETS:-}
    depends_on:
      redis:
        condition: service_healthy
      zap:
        condition: service_healthy
      juice-shop:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import redis; redis.Redis(host='redis').ping()",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network

  # Dashboard - Real-time Streamlit monitoring UI (Phase 3)
  dashboard:
    container_name: hemostat-dashboard
    build:
      context: .
      dockerfile: dashboard/Dockerfile
    ports:
      - "8501:8501"
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DASHBOARD_REFRESH_INTERVAL: ${DASHBOARD_REFRESH_INTERVAL:-5}
      DASHBOARD_MAX_EVENTS: ${DASHBOARD_MAX_EVENTS:-100}
      DASHBOARD_AUTO_REFRESH: ${DASHBOARD_AUTO_REFRESH:-true}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8501/_stcore/health')",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network

  # Test Services (Phase 4) - For demo and integration testing

  # Juice Shop - Vulnerable web application for security testing
  juice-shop:
    container_name: hemostat-juice-shop
    image: bkimminich/juice-shop
    ports:
      - "3000:3000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network
    labels:
      hemostat.test: "true"
      hemostat.service: "juice-shop"
      hemostat.vuln-target: "true"

  # OWASP ZAP - Security vulnerability scanner
  zap:
    container_name: hemostat-zap
    image: zaproxy/zap-weekly
    command: zap.sh -daemon -port 8080 -host 0.0.0.0 -config api.addrs.addr.name=.* -config api.addrs.addr.regex=true
    ports:
      - "8080:8080" # ZAP API exposed here
    restart: unless-stopped
    healthcheck:
      test:
        ["CMD", "curl", "-f", "http://localhost:8080/JSON/core/view/version/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - hemostat-network
    labels:
      hemostat.service: "zap"
      hemostat.security: "true"

  # Test API - HTTP service with controllable resource usage
  test-api:
    container_name: hemostat-test-api
    image: python:3.11-slim
    command: python /app/test_api.py
    volumes:
      - ./scripts/test_api.py:/app/test_api.py:ro
      - ./agents:/app/agents:ro
    environment:
      PYTHONUNBUFFERED: 1
      FLASK_APP: test_api.py
    ports:
      - "5001:5000"
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:5001/health')",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network
    labels:
      hemostat.test: "true"
      hemostat.service: "test-api"

  # Test Worker - Background worker with periodic resource spikes
  test-worker:
    container_name: hemostat-test-worker
    image: python:3.11-slim
    command: python /app/test_worker.py
    volumes:
      - ./scripts/test_worker.py:/app/test_worker.py:ro
      - ./agents:/app/agents:ro
    environment:
      PYTHONUNBUFFERED: 1
      WORKER_INTERVAL: ${WORKER_INTERVAL:-60}
      WORKER_SPIKE_PROBABILITY: ${WORKER_SPIKE_PROBABILITY:-0.1}
      WORKER_SPIKE_DURATION: ${WORKER_SPIKE_DURATION:-30}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network
    labels:
      hemostat.test: "true"
      hemostat.service: "test-worker"

networks:
  hemostat-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
