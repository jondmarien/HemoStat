services:
  # Redis service for pub/sub messaging and shared state
  redis:
    image: redis:7-alpine
    container_name: hemostat-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - hemostat-network

  # Monitor Agent - Continuously polls Docker containers for health issues
  monitor:
    container_name: hemostat-monitor
    user: root
    build:
      context: .
      dockerfile: agents/hemostat_monitor/Dockerfile
    environment:
      DOCKER_HOST: unix:///var/run/docker.sock
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      AGENT_POLL_INTERVAL: ${AGENT_POLL_INTERVAL:-30}
      THRESHOLD_CPU_PERCENT: ${THRESHOLD_CPU_PERCENT:-85}
      THRESHOLD_MEMORY_PERCENT: ${THRESHOLD_MEMORY_PERCENT:-80}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; redis.Redis(host='redis').ping()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network

  # Analyzer Agent - Performs AI-powered root cause analysis of health issues
  analyzer:
    container_name: hemostat-analyzer
    build:
      context: .
      dockerfile: agents/hemostat_analyzer/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      AI_MODEL: ${AI_MODEL:-gpt-4}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      AI_FALLBACK_ENABLED: ${AI_FALLBACK_ENABLED:-true}
      ANALYZER_CONFIDENCE_THRESHOLD: ${ANALYZER_CONFIDENCE_THRESHOLD:-0.7}
      ANALYZER_HISTORY_SIZE: ${ANALYZER_HISTORY_SIZE:-10}
      ANALYZER_HISTORY_TTL: ${ANALYZER_HISTORY_TTL:-3600}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; redis.Redis(host='redis').ping()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network

  # Responder Agent - Executes safe container remediation with safety constraints
  responder:
    container_name: hemostat-responder
    user: root
    build:
      context: .
      dockerfile: agents/hemostat_responder/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      RESPONDER_COOLDOWN_SECONDS: ${RESPONDER_COOLDOWN_SECONDS:-3600}
      RESPONDER_MAX_RETRIES_PER_HOUR: ${RESPONDER_MAX_RETRIES_PER_HOUR:-3}
      RESPONDER_DRY_RUN: ${RESPONDER_DRY_RUN:-false}
      RESPONDER_ENFORCE_EXEC_ALLOWLIST: ${RESPONDER_ENFORCE_EXEC_ALLOWLIST:-false}
      DOCKER_HOST: unix:///var/run/docker.sock
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; redis.Redis(host='redis').ping()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network

  # Alert Agent - Sends notifications and stores events for dashboard
  alert:
    container_name: hemostat-alert
    build:
      context: .
      dockerfile: agents/hemostat_alert/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL}
      ALERT_ENABLED: ${ALERT_ENABLED:-true}
      ALERT_EVENT_TTL: ${ALERT_EVENT_TTL:-3600}
      ALERT_MAX_EVENTS: ${ALERT_MAX_EVENTS:-100}
      ALERT_DEDUPE_TTL: ${ALERT_DEDUPE_TTL:-60}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; redis.Redis(host='redis').ping()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network

  # Dashboard - Real-time Streamlit monitoring UI (Phase 3)
  dashboard:
    container_name: hemostat-dashboard
    build:
      context: .
      dockerfile: dashboard/Dockerfile
    ports:
      - "8501:8501"
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DASHBOARD_REFRESH_INTERVAL: ${DASHBOARD_REFRESH_INTERVAL:-5}
      DASHBOARD_MAX_EVENTS: ${DASHBOARD_MAX_EVENTS:-100}
      DASHBOARD_AUTO_REFRESH: ${DASHBOARD_AUTO_REFRESH:-true}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network

  # Test Services (Phase 4) - For demo and integration testing
  
  # Test API - HTTP service with controllable resource usage
  test-api:
    container_name: hemostat-test-api
    image: python:3.11-slim
    command: python /app/test_api.py
    volumes:
      - ./scripts/test_api.py:/app/test_api.py:ro
      - ./agents:/app/agents:ro
    environment:
      PYTHONUNBUFFERED: 1
      FLASK_APP: test_api.py
    ports:
      - "5000:5000"
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network
    labels:
      hemostat.test: "true"
      hemostat.service: "test-api"
  
  # Test Worker - Background worker with periodic resource spikes
  test-worker:
    container_name: hemostat-test-worker
    image: python:3.11-slim
    command: python /app/test_worker.py
    volumes:
      - ./scripts/test_worker.py:/app/test_worker.py:ro
      - ./agents:/app/agents:ro
    environment:
      PYTHONUNBUFFERED: 1
      WORKER_INTERVAL: ${WORKER_INTERVAL:-60}
      WORKER_SPIKE_PROBABILITY: ${WORKER_SPIKE_PROBABILITY:-0.1}
      WORKER_SPIKE_DURATION: ${WORKER_SPIKE_DURATION:-30}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hemostat-network
    labels:
      hemostat.test: "true"
      hemostat.service: "test-worker"

networks:
  hemostat-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
