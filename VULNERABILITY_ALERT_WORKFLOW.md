# HemoStat Vulnerability Alert Workflow

This document describes the complete vulnerability detection and alerting workflow in HemoStat, from vulnerability scanning to Slack notifications.

## ğŸ”„ Complete Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Vulnerability   â”‚    â”‚ Redis Channel    â”‚    â”‚ Alert Agent     â”‚    â”‚ Slack Channel   â”‚
â”‚ Scanner Agent   â”‚â”€â”€â”€â–¶â”‚ hemostat:alerts  â”‚â”€â”€â”€â–¶â”‚ Processing      â”‚â”€â”€â”€â–¶â”‚ Notification    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step-by-Step Process

#### 1. **Vulnerability Detection** ğŸ”
- **Agent**: Vulnerability Scanner (`vulnscanner`)
- **Action**: Scans web applications using OWASP ZAP
- **Trigger**: Periodic scans (default: every hour)
- **Detection**: Identifies security vulnerabilities by risk level

#### 2. **Critical Alert Publishing** ğŸ“¤
- **Condition**: High-risk vulnerabilities found
- **Channel**: `hemostat:alerts`
- **Event Type**: `critical_vulnerabilities_found`
- **Data**: Vulnerability details, counts, target information

#### 3. **Alert Processing** ğŸš¨
- **Agent**: Alert Agent (`alert`)
- **Action**: Receives and processes vulnerability alerts
- **Storage**: Stores events in Redis for dashboard consumption
- **Deduplication**: Prevents spam notifications

#### 4. **Slack Notification** ğŸ’¬
- **Format**: Rich Slack attachment with vulnerability details
- **Color**: Red (#ff0000) for critical security alerts
- **Content**: Target URL, vulnerability counts, specific vulnerability details
- **Retry Logic**: Exponential backoff for failed deliveries

## ğŸ“‹ Message Format

### Redis Channel Message
```json
{
  "event_type": "critical_vulnerabilities_found",
  "agent": "vulnscanner",
  "timestamp": "2024-01-01T12:00:00Z",
  "severity": "high",
  "message": "Found 3 critical vulnerabilities in http://juice-shop:3000",
  "data": {
    "target_url": "http://juice-shop:3000",
    "critical_count": 3,
    "total_count": 15,
    "critical_vulns": [
      {
        "name": "SQL Injection",
        "url": "http://juice-shop:3000/api/users",
        "param": "email",
        "description": "SQL injection vulnerability detected",
        "solution": "Use parameterized queries",
        "reference": "https://owasp.org/www-community/attacks/SQL_Injection"
      }
    ]
  }
}
```

### Slack Message Format
The Alert Agent formats vulnerability alerts as rich Slack attachments:

- **ğŸš¨ Title**: "X Critical Vulnerabilities Detected"
- **ğŸ”— Link**: Target URL (if valid HTTP/HTTPS)
- **ğŸ“Š Fields**:
  - Event Type: Critical Vulnerabilities Found
  - Target: Application URL
  - Critical Vulnerabilities: Count
  - Total Vulnerabilities: Count
  - Critical Vulnerability Details: Top 3 vulnerabilities with details
  - Scan Time: Formatted timestamp

## âš™ï¸ Configuration

### Environment Variables

#### Vulnerability Scanner
```bash
VULNSCANNER_INTERVAL=3600        # Scan every hour
VULNSCANNER_TARGETS=             # Additional targets (comma-separated)
```

#### Alert Agent
```bash
SLACK_WEBHOOK_URL=               # Slack webhook URL (required for notifications)
ALERT_ENABLED=true               # Enable/disable alerts
ALERT_DEDUPE_TTL=60             # Deduplication window (seconds)
```

### Slack Webhook Setup

1. **Create Slack App**:
   - Go to https://api.slack.com/apps
   - Create new app for your workspace

2. **Enable Incoming Webhooks**:
   - Navigate to "Incoming Webhooks"
   - Activate incoming webhooks
   - Add new webhook to workspace

3. **Configure HemoStat**:
   ```bash
   export SLACK_WEBHOOK_URL="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
   ```

## ğŸš€ Deployment

### 1. Start Core Services
```bash
# Start Redis and base infrastructure
docker-compose up -d redis

# Start vulnerability scanning components
docker-compose up -d juice-shop zap vulnscanner

# Start alert processing
docker-compose up -d alert
```

### 2. Verify Workflow
```bash
# Test the complete workflow
python test_vulnerability_workflow.py

# Monitor logs
docker-compose logs -f vulnscanner alert
```

### 3. Monitor Results
- **Slack**: Check configured channel for vulnerability alerts
- **Dashboard**: View at http://localhost:8501
- **Redis**: Monitor channels directly
  ```bash
  redis-cli -h localhost subscribe hemostat:alerts
  ```

## ğŸ” Monitoring & Troubleshooting

### Log Analysis

#### Vulnerability Scanner Logs
```bash
docker-compose logs vulnscanner | grep "critical vulnerabilities"
```

#### Alert Agent Logs
```bash
docker-compose logs alert | grep "vulnerability_alert"
```

### Common Issues

#### 1. **No Slack Notifications**
- **Check**: Webhook URL configuration
- **Verify**: Alert Agent is running and subscribed
- **Test**: Use test script to verify formatting

#### 2. **Duplicate Notifications**
- **Cause**: Deduplication TTL too short
- **Solution**: Increase `ALERT_DEDUPE_TTL`

#### 3. **Missing Vulnerabilities**
- **Check**: ZAP connectivity and scan completion
- **Verify**: Target applications are accessible
- **Monitor**: Vulnerability scanner logs

### Redis Monitoring

#### Check Stored Events
```bash
# View vulnerability alert events
redis-cli -h localhost lrange hemostat:events:vulnerability_alert 0 -1

# Check deduplication cache
redis-cli -h localhost keys "hemostat:alert_sent:*"
```

#### Monitor Live Channels
```bash
# Subscribe to vulnerability alerts
redis-cli -h localhost subscribe hemostat:alerts

# Subscribe to all HemoStat events
redis-cli -h localhost psubscribe "hemostat:*"
```

## ğŸ¯ Customization

### Adding Custom Vulnerability Targets

#### Via Environment Variable
```bash
export VULNSCANNER_TARGETS="http://myapp:8080,http://api:3000"
docker-compose up -d vulnscanner
```

#### Via Docker Compose Override
```yaml
# docker-compose.override.yml
services:
  vulnscanner:
    environment:
      VULNSCANNER_TARGETS: "http://myapp:8080,http://api:3000"
```

### Custom Slack Formatting

Modify the `_format_vulnerability_notification` method in:
`agents/hemostat_alert/alert.py`

### Alert Filtering

Add custom logic to filter alerts by:
- Vulnerability type
- Risk threshold
- Target application
- Time of day

## ğŸ“Š Metrics & Analytics

### Key Metrics
- **Vulnerability Detection Rate**: Vulnerabilities found per scan
- **Alert Response Time**: Time from detection to notification
- **False Positive Rate**: Alerts vs. actual security issues
- **Coverage**: Applications scanned vs. total applications

### Dashboard Integration
The HemoStat dashboard displays:
- Real-time vulnerability status
- Historical vulnerability trends
- Risk level distribution
- Target application security scores

## ğŸ”’ Security Considerations

### Data Sensitivity
- Vulnerability data contains sensitive security information
- Implement proper access controls for Redis and logs
- Consider data retention policies for vulnerability reports

### Network Security
- Restrict ZAP API access to internal networks
- Use secure channels for Slack webhooks
- Monitor for unauthorized access to vulnerability data

### Operational Security
- Regularly update ZAP and vulnerability definitions
- Review and validate vulnerability findings
- Implement incident response procedures for critical vulnerabilities

## ğŸ“š Related Documentation

- [Vulnerability Scanner Quick Start](VULNSCANNER_QUICKSTART.md)
- [HemoStat Architecture](docs/architecture.md)
- [Alert Agent Configuration](agents/hemostat_alert/README.md)
- [OWASP ZAP Documentation](https://www.zaproxy.org/docs/)

## ğŸ†˜ Support

For issues with the vulnerability alert workflow:

1. **Check Service Status**: `docker-compose ps`
2. **Review Logs**: `docker-compose logs vulnscanner alert`
3. **Test Components**: Run `test_vulnerability_workflow.py`
4. **Verify Configuration**: Check environment variables
5. **Monitor Redis**: Use Redis CLI to inspect channels and data
