#!/usr/bin/env python3
"""
Test script for HemoStat Vulnerability ‚Üí Alert ‚Üí Slack workflow

This script tests the complete integration:
1. Vulnerability Scanner detects vulnerabilities
2. Publishes to hemostat:alerts channel
3. Alert Agent receives and processes alerts
4. Sends formatted Slack notifications

Usage:
    python test_vulnerability_workflow.py
"""

import json
import time
import redis
from datetime import datetime, UTC


def test_vulnerability_alert_workflow():
    """Test the complete vulnerability alert workflow."""
    print("üîç Testing Vulnerability ‚Üí Alert ‚Üí Slack Workflow")
    print("=" * 60)
    
    # Connect to Redis
    try:
        r = redis.Redis(host='localhost', port=6379, decode_responses=True)
        r.ping()
        print("‚úÖ Connected to Redis")
    except Exception as e:
        print(f"‚ùå Failed to connect to Redis: {e}")
        return False
    
    # Create a mock vulnerability alert (simulating what the vulnerability scanner would send)
    mock_vulnerability_alert = {
        "event_type": "critical_vulnerabilities_found",
        "agent": "vulnscanner",
        "timestamp": datetime.now(UTC).isoformat(),
        "severity": "high",
        "message": "Found 3 critical vulnerabilities in http://juice-shop:3000",
        "data": {
            "target_url": "http://juice-shop:3000",
            "critical_count": 3,
            "total_count": 15,
            "critical_vulns": [
                {
                    "name": "SQL Injection",
                    "url": "http://juice-shop:3000/api/users",
                    "param": "email",
                    "description": "SQL injection vulnerability detected in user authentication",
                    "solution": "Use parameterized queries to prevent SQL injection",
                    "reference": "https://owasp.org/www-community/attacks/SQL_Injection"
                },
                {
                    "name": "Cross-Site Scripting (XSS)",
                    "url": "http://juice-shop:3000/search",
                    "param": "q",
                    "description": "Reflected XSS vulnerability in search functionality",
                    "solution": "Implement proper input validation and output encoding",
                    "reference": "https://owasp.org/www-community/attacks/xss/"
                },
                {
                    "name": "Broken Authentication",
                    "url": "http://juice-shop:3000/login",
                    "param": "password",
                    "description": "Weak password policy allows brute force attacks",
                    "solution": "Implement strong password policies and rate limiting",
                    "reference": "https://owasp.org/www-project-top-ten/2017/A2_2017-Broken_Authentication"
                }
            ]
        }
    }
    
    print("\nüì§ Publishing mock vulnerability alert to hemostat:alerts channel...")
    print(f"   Target: {mock_vulnerability_alert['data']['target_url']}")
    print(f"   Critical Vulnerabilities: {mock_vulnerability_alert['data']['critical_count']}")
    print(f"   Total Vulnerabilities: {mock_vulnerability_alert['data']['total_count']}")
    
    try:
        # Publish the alert to the hemostat:alerts channel
        r.publish("hemostat:alerts", json.dumps(mock_vulnerability_alert))
        print("‚úÖ Alert published successfully")
        
        # Wait a moment for processing
        time.sleep(2)
        
        # Check if the alert agent processed it by looking for stored events
        alert_events = r.lrange("hemostat:events:vulnerability_alert", 0, -1)
        
        if alert_events:
            print(f"‚úÖ Alert Agent processed the event ({len(alert_events)} events stored)")
            
            # Show the stored event
            latest_event = json.loads(alert_events[0])
            print(f"   Event Type: {latest_event.get('event_type')}")
            print(f"   Timestamp: {latest_event.get('timestamp')}")
            print(f"   Target: {latest_event.get('data', {}).get('target_url')}")
            
        else:
            print("‚ö†Ô∏è  No events found in Redis - Alert Agent may not be running")
        
        # Check for deduplication cache (indicates Slack notification was attempted)
        keys = r.keys("hemostat:alert_sent:*")
        if keys:
            print(f"‚úÖ Slack notification attempted ({len(keys)} dedup entries)")
        else:
            print("‚ÑπÔ∏è  No Slack notification dedup entries found")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Failed to publish alert: {e}")
        return False


def test_slack_formatting():
    """Test the Slack message formatting with sample data."""
    print("\nüé® Testing Slack Message Formatting")
    print("=" * 40)
    
    # Import the alert agent to test formatting
    try:
        from agents.hemostat_alert import AlertNotifier
        
        # Create a mock alert agent (won't actually send to Slack)
        alert_agent = AlertNotifier()
        
        # Sample vulnerability data
        sample_data = {
            "target_url": "http://juice-shop:3000",
            "critical_count": 2,
            "total_count": 8,
            "timestamp": datetime.now(UTC).isoformat(),
            "critical_vulns": [
                {
                    "name": "SQL Injection",
                    "url": "http://juice-shop:3000/api/users",
                    "param": "email",
                    "description": "SQL injection vulnerability detected"
                },
                {
                    "name": "XSS",
                    "url": "http://juice-shop:3000/search",
                    "param": "q",
                    "description": "Cross-site scripting vulnerability"
                }
            ]
        }
        
        # Test the formatting function
        formatted_message = alert_agent._format_vulnerability_notification(sample_data)
        
        if formatted_message:
            print("‚úÖ Slack message formatted successfully")
            
            # Show the formatted message structure
            attachment = formatted_message["attachments"][0]
            print(f"   Title: {attachment['title']}")
            print(f"   Color: {attachment['color']}")
            print(f"   Fields: {len(attachment['fields'])} fields")
            
            # Show field details
            for field in attachment["fields"]:
                print(f"     - {field['title']}: {field['value'][:50]}...")
            
            return True
        else:
            print("‚ùå Failed to format Slack message")
            return False
            
    except Exception as e:
        print(f"‚ùå Error testing Slack formatting: {e}")
        return False


def main():
    """Main test function."""
    print("üîí HemoStat Vulnerability Alert Workflow Test")
    print("=" * 60)
    
    results = []
    
    # Test 1: Vulnerability alert workflow
    print("\n1Ô∏è‚É£ Testing Alert Workflow...")
    workflow_result = test_vulnerability_alert_workflow()
    results.append(("Alert Workflow", workflow_result))
    
    # Test 2: Slack formatting
    print("\n2Ô∏è‚É£ Testing Slack Formatting...")
    formatting_result = test_slack_formatting()
    results.append(("Slack Formatting", formatting_result))
    
    # Summary
    print("\n" + "=" * 60)
    print("üìä Test Results Summary")
    print("=" * 60)
    
    passed = 0
    for test_name, result in results:
        status = "‚úÖ PASS" if result else "‚ùå FAIL"
        print(f"{test_name}: {status}")
        if result:
            passed += 1
    
    print(f"\nOverall: {passed}/{len(results)} tests passed")
    
    if passed == len(results):
        print("\nüéâ All tests passed! The vulnerability alert workflow is ready.")
        print("\nüìã Next Steps:")
        print("1. Configure Slack webhook URL: export SLACK_WEBHOOK_URL='https://hooks.slack.com/...'")
        print("2. Start the Alert Agent: docker-compose up -d alert")
        print("3. Start the Vulnerability Scanner: docker-compose up -d vulnscanner")
        print("4. Monitor Slack for vulnerability alerts!")
    else:
        print("\n‚ö†Ô∏è  Some tests failed. Check the output above for details.")
        print("\nTroubleshooting:")
        print("- Ensure Redis is running: docker-compose up -d redis")
        print("- Check Alert Agent logs: docker-compose logs alert")
        print("- Verify Slack webhook configuration")
    
    return 0 if passed == len(results) else 1


if __name__ == "__main__":
    exit(main())
